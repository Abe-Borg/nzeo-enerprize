{% extends "base_sise_navbar.html" %}
{% load static %}

{% block main_container_nzeo_staff %}
<style>
    /* Custom CSS for smaller error messages */
    .form-error {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
        padding: .75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: .25rem;
        font-size: 0.875rem; 
    }
    .error-message-box {
      padding: 0.25rem; 
      margin-bottom: 0.1rem; 
    }
    .has-error input, .has-error select {
    border-color: #d9534f; 
    }
</style>

<div class="main-container fullscreen">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-xl-5 col-lg-6 col-md-7">
          <div class="text-center">
            <h1 class="h2">Enter a Utility Bill</h1>
            <hr>
            <form method = "post">
              {% csrf_token %}
                <!-- Utilty selection -->
                <div class="form-group">
                    <label for="{{ form.utility_type.id_for_label }}">Utility Type:</label>
                    {{ form.utility_type }}
                </div>
                <!-- District Selection -->
                <div class="form-group">
                <label>District:</label>
                <select class="form-control" name="bill_district" id="bill_district" required>
                    <option value="">Select District</option>
                    {% for district in districts %}
                    <option value="{{ district.id }}">{{ district.district_name | capfirst }}</option>
                    {% endfor %}
                </select>
                </div>
                <!-- School Selection -->
                <div class="form-group">
                    <label for="{{ form.school.id_for_label }}">School:</label>
                    <select class="form-control" name="bill_school" id="bill_school" disabled required>
                        <option value="">Select School</option>
                        <!-- Options will be populated based on district selection -->
                    </select>
                </div>
                <!-- service agreement id-->
                <div class="form-group {% if form.service_agreement_id.errors %} has-error{% endif %}">
                    <label for="{{ form.service_agreement_id.id_for_label }}">Service Agreement ID:</label>
                    {{ form.service_agreement_id }}
                    <!-- <input type="text" class="form-control" name="service_agreement_id" id="service_agreement_id" required> -->
                    <div class="error-message-box">
                        {% for error in form.service_agreement_id.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- meter id -->
                <div class="form-group {% if form.meter_id.errors %} has-error{% endif %}">
                    <label for= "{{ form.meter_id.id_for_label }}">Meter ID:</label>
                    <input type="text" class="form-control" name="meter_id" id="meter_id" required>
                    <div class="error-message-box">
                        {% for error in form.meter_id.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- Utility Bill Start Date -->
                <div class="form-group {% if form.bill_start_date.errors %} has-error{% endif %}">
                    <label for="{{ form.bill_start_date.id_for_label }}">Utility Bill Date:</label>
                    <input type="date" class="form-control" name="bill_start_date" id="bill_start_date" required>
                    <div class="error-message-box">
                        {% for error in form.bill_start_date.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- Utility Bill End Date -->
                <div class="form-group {% if form.bill_end_date.errors %} has-error{% endif %}">
                    <label for="{{ form.bill_end_date.id_for_label }}">Utility Bill End Date:</label>
                    <input type="date" class="form-control" name="bill_end_date" id="bill_end_date" required>
                    <div class="error-message-box">
                        {% for error in form.bill_end_date.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- total electric charges  $-->
                <div class="form-group {% if form.total_electric_charges.errors %} has-error{% endif %}">
                  <label for="{{ form.total_electric_charges.id_for_label }}">Total Electric Charges:</label>
                  <input type="number" class="form-control" name="total_electric_charges" id="total_electric_charges">
                  <div class="error-message-box">
                    {% for error in form.total_electric_charges.errors %}
                      <p class="form-error">{{ error }}</p>
                    {% endfor %}
                    </div>
                </div>
                <!-- total gas charges $ -->
                <div class="form-group {% if form.total_gas_charges.errors %} has-error{% endif %}">
                    <label for="{{ form.total_gas_charges.id_for_label }}">Total Gas Charges:</label>
                    <input type="number" class="form-control" name="total_gas_charges" id="total_gas_charges">
                    <div class="error-message-box">
                        {% for error in form.total_gas_charges.errors %}
                        <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- electric consumption_kWh-->
                <div class="form-group {% if form.elec_consumption_kwh.errors %} has-error{% endif %}">
                    <label for="{{ form.elec_consumption_kwh.id_for_label }}">Electric Consumption (kWh):</label>
                    <input type="number" class="form-control" name="elec_consumption_kwh" id="elec_consumption_kwh">
                    <div class="error-message-box">
                        {% for error in form.elec_consumption_kwh.errors %}
                            <p class="form-error
                            ">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- gas consumption_therms-->
                <div class="form-group {% if form.gas_consumption_therms.errors %} has-error{% endif %}">
                    <label for="{{ form.gas_consumption_therms.id_for_label }}">Gas Consumption (Therms):</label>
                    <input type="number" class="form-control" name="gas_consumption_therms" id="gas_consumption_therms">
                    <div class="error-message-box">
                        {% for error in form.gas_consumption_therms.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- peak demand kWh-->
                <div class="form-group {% if form.peak_demand_kwh.errors %} has-error{% endif %}">
                    <label for="{{ form.peak_demand_kwh.id_for_label }}">Peak Demand (kW):</label>
                    <input type="number" class="form-control" name="peak_demand_kwh" id="peak_demand_kwh">
                    <div class="error-message-box">
                        {% for error in form.peak_demand_kwh.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- off peak demand -->
                <div class="form-group {% if form.off_peak_demand_kwh.errors %} has-error{% endif %}">
                    <label for="{{ form.off_peak_demand_kwh.id_for_label }}">Off Peak Demand (kW):</label>
                    <input type="number" class="form-control" name="off_peak_demand_kwh" id="off_peak_demand_kwh">
                    <div class="error-message-box">
                        {% for error in form.off_peak_demand_kwh.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <br>
                <p>Do you have solar generation or solar energy credits data to enter?</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="solar_generation_checkbox">
                    <label class="form-check-label" for="solar_generation_checkbox">
                        Yes, I have solar generation or solar energy credits data to enter.
                    </label>
                </div>
                <br>
                <!-- solar generation kWh -->
                <div class="form-group {% if form.solar_generation_kwh.errors %} has-error{% endif %}">
                    <label for="{{ form.solar_generation_kwh.id_for_label }}">Solar Generation (kWh):</label>
                    <input type="number" class="form-control" name="solar_generation_kwh" id="solar_generation_kwh" disabled>
                    <div class="error-message-box">
                        {% for error in form.solar_generation_kwh.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <!-- solar energy credits $ -->
                <div class="form-group {% if form.solar_energy_credits.errors %} has-error{% endif %}">
                    <label for="{{ form.solar_energy_credits.id_for_label }}">Solar Energy Credits:</label>
                    <input type="number" class="form-control" name="solar_energy_credits" id="solar_energy_credits" disabled>
                    <div class="error-message-box">
                        {% for error in form.solar_energy_credits.errors %}
                            <p class="form-error">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
                <br>
                <button type="submit" name="action" value="save_and_add_another" class="btn btn-secondary">Save and Add Another</button>
                <button type="submit" name="action" value="save_and_return" class="btn btn-primary">Save and Return to Overview</button>              
            </form>
 
          </div>
        </div>
      </div>
    </div>
  </div>
  
<script>
document.addEventListener('DOMContentLoaded', function() {
    const districtSelect = document.getElementById('bill_district');
    const schoolSelect = document.getElementById('bill_school');

    districtSelect.addEventListener('change', function() {
        const districtId = this.value;
        schoolSelect.innerHTML = '<option value="">Select School</option>'; 

        if (districtId) {
            schoolSelect.disabled = false;

            // Fetch schools for the selected district
            console.log(`Fetching schools for district ID: ${districtId}`);
            fetch(`/enerprize-api/get-schools-for-district/${districtId}/`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                data.schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.school_name;
                schoolSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error:', error));
        } else {
            // Disable school dropdown if no district is selected
            schoolSelect.disabled = true;
        }
    });
});

document.getElementById('solar_generation_checkbox').addEventListener('change', function() {
    const solarGenerationKWh = document.getElementById('solar_generation_kWh');
    const solarEnergyCredits = document.getElementById('solar_energy_credits');
    const isChecked = this.checked;

    solarGenerationKWh.disabled = !isChecked; // Disable or enable based on checkbox
    solarEnergyCredits.disabled = !isChecked;

    if (isChecked) {
        solarGenerationKWh.required = true;
        solarEnergyCredits.required = true;
    } else {
        solarGenerationKWh.required = false;
        solarEnergyCredits.required = false;
        solarGenerationKWh.value = ''; 
        solarEnergyCredits.value = ''; 
    }
});
</script>
{% endblock %}