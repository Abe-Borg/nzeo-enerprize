{% extends "base_side_navbar.html" %}
{% load static %}

{% block main_container_nzeo_staff %}
<style>
.text-center h1 {
    margin-top: 2rem;
}

.text-center .h2 {
align-items: center;
justify-content: center;
}

.icon-button {
    margin-left: 10px; /* Adjust the space between the title and the icon */
    background: none;
    border: none;
    cursor: pointer;
    display: inline-flex; /* This will keep the icon and text aligned inline */
    align-items: center; /* Vertical alignment */
}

.icon-button i {
    font-size: 24px; /* Adjust icon size as needed */
}
.custom-tooltip {
    margin-left: 10px; /* Provides additional space for the tooltip text */
    font-size: 12px; /* Adjust as needed */
    white-space: nowrap; /* Prevents the tooltip text from wrapping */
}
@media (max-width: 768px) {
    .text-center .h2 {
        flex-direction: column;
    }
    .icon-button {
        margin-left: 0;
        margin-top: 10px;
    }
    .custom-tooltip {
        margin-left: 0;
    }
}
</style>

<div class="main-container fullscreen">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-xl-5 col-lg-6 col-md-7">
            <div class="text-center">
                <h1 class="h2">
                    Enter a Utility Bill
                    <button type = "button" class = "icon-button" id = "message-question-icon-button">
                        <i class="fa-regular fa-cloud-arrow-up">Upload Utility Bill</i>
                    </button>
                </h1>
                <hr><br>
                <form method = "post">
                {% csrf_token %}
                    <!-- Utilty selection -->
                    <div class="form-group">
                        <select class="form-control" name="{{ form.utility_type.name }}" id="{{ form.utility_type.id_for_label }}">
                            <option value="" selected disabled>Select Utility Type</option>
                            {% for value, display in utility_type_choices %}
                                <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- District Selection -->
                    <div class="form-group">
                        <select class="form-control" name="bill_district" id="bill_district" required>
                            <option value="" selected disabled>Select District</option>
                                {% for district in districts %}
                            <option value="{{ district.id }}">{{ district.district_name | capfirst }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- School Selection -->
                    <div class="form-group">
                        <select class="form-control" name="{{ form.school.name }}" id="{{ form.school.id_for_label }}" disabled required>
                            <option value="" selected disabled>Select School</option>
                            <!-- Options will be populated based on district selection -->
                        </select>
                    </div>
                    <!-- service agreement id-->
                    <div class="form-group">
                        <input class="form-control" type="text" name="{{ form.service_agreement_id.name }}" placeholder="Service Agreement ID" id="{{ form.service_agreement_id.id_for_label }}"/>
                    </div>
                    <!-- electricity meter id -->
                    <div class="form-group">
                        <input type="text" class="form-control" name= "{{ form.meter_id.name }}" placeholder="Electricity Meter ID" id="{{ form.meter_id.id_for_label }}" required>
                    </div>
                    <!-- Utility Bill Start Date -->
                    <div class="form-group">
                        <label>Utility Bill Start Date:</label>
                        <input type="date" class="form-control" name="{{ form.bill_start_date.name }}" id="{{ form.bill_start_date.id_for_label }}" required>
                    </div>
                    <!-- Utility Bill End Date -->
                    <div class="form-group">
                        <label for="{{ form.bill_end_date.id_for_label }}">Utility Bill End Date:</label>
                        <input type="date" class="form-control" name="bill_end_date" id="bill_end_date" required>
                    </div>
                    <!-- total electric charges  $-->
                    <div class="form-group" >
                    <input type="number" class="form-control" placeholder = "Total Electric Charges $" name="{{ form.total_electric_charges.name }}" id="{{ form.total_electric_charges.id_for_label }}" disabled>
                    </div>
                    <!-- total gas charges $ -->
                    <div class="form-group">
                        <input type="number" class="form-control" placeholder="Total Gas Charges $" name="{{ form.total_gas_charges.name }}" id="{{ form.total_gas_charges.id_for_label }}" disabled>
                    </div>
                    <!-- electric consumption_kWh-->
                    <div class="form-group">
                        <input type="number" class="form-control" placeholder="Electric Consumption (kWh)" name="{{ form.elec_consumption_kwh.name }}" id="{{ form.elec_consumption_kwh.id_for_label }}" disabled>
                    </div>
                    <!-- gas consumption_therms-->
                    <div class="form-group">
                        <input type="number" class="form-control" placeholder="Gas Consumption (Therms)" name="{{ form.gas_consumption_therms.name }}" id="{{ form.gas_consumption_therms.id_for_label }}" disabled>
                    </div>
                    <br>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="solar_generation_checkbox">
                        <label class="form-check-label" for="solar_generation_checkbox">
                            I have solar generation or solar energy credits data to enter.
                        </label>
                    </div>
                    <br>
                    <!-- solar generation kWh -->
                    <div class="form-group">
                        <input type="number" class="form-control" placeholder="Solar Generation (kWh)" name="{{ form.solar_generation_kwh.name }}" id="{{ form.solar_generation_kwh.id_for_label }}" disabled>
                    </div>
                    <!-- solar energy credits $ -->
                    <div class="form-group {% if form.solar_energy_credits.errors %} has-error{% endif %}">
                        <input type="number" class="form-control" placeholder="Solar Energy Credits $" name="{{ form.solar_energy_credits.name }}" id="{{ form.solar_energy_credits.id_for_label }}" disabled>
                    </div>
                    <br>
                    <button type="submit" name="action" value="save_and_add_another" class="btn btn-secondary">Save and Add Another</button>
                    <button type="submit" name="action" value="save_and_return" class="btn btn-primary">Save and Return to Overview</button>              
                </form>
            </div>
        </div>
      </div>
    </div>
  </div>
  
<script>
document.addEventListener('DOMContentLoaded', function() {
    const districtSelect = document.getElementById('bill_district');
    const schoolSelect = document.getElementById("{{ form.school.id_for_label }}");

    // Function to fetch schools based on the selected district
    function fetchSchools(districtId) {
        schoolSelect.innerHTML = '<option value="">Select School</option>';
        if (districtId) {
            schoolSelect.disabled = false;
            fetch(`/enerprize-api/get-schools-for-district/${districtId}/`)
                .then(response => response.json())
                .then(data => {
                    data.schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.school_name;
                        schoolSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        } else {
            schoolSelect.disabled = true;
        }
    }
    // Fetch all districts on page load
    fetch('/enerprize-api/get-all-districts/')
        .then(response => response.json())
        .then(data => {
            data.districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district.id;
                option.textContent = district.district_name;
                districtSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error fetching districts:', error));

    // Add change event listener to district select
    districtSelect.addEventListener('change', function() {
        fetchSchools(this.value);
    });
});

document.getElementById('solar_generation_checkbox').addEventListener('change', function() {
    const solarGenerationKWh = document.getElementById("{{ form.solar_generation_kwh.id_for_label }}");
    const solarEnergyCredits = document.getElementById("{{ form.solar_energy_credits.id_for_label }}");
    const isChecked = this.checked;

    solarGenerationKWh.disabled = !isChecked;
    solarEnergyCredits.disabled = !isChecked;

    if (isChecked) {
        solarGenerationKWh.required = true;
        solarEnergyCredits.required = true;
    } else {
        solarGenerationKWh.required = false;
        solarEnergyCredits.required = false;
        solarGenerationKWh.value = ''; 
        solarEnergyCredits.value = '';  
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const utilityTypeSelect = document.getElementById("{{ form.utility_type.id_for_label }}");
    const totalGasChargesInput = document.getElementById("{{ form.total_gas_charges.id_for_label}");
    const gasConsumptionInput = document.getElementById("{{ form.gas_consumption_therms.id_for_label }}");
    const totalElectricChargesInput = document.getElementById("{{ form.total_electric_charges.id_for_label }}");
    const electricConsumptionInput = document.getElementById("{{ form.elec_consumption_kwh.id_for_label }}");
    const electricPeakDemandInput = document.getElementById("{{ form.peak_demand_kwh.id_for_label }}");
    const electricOffPeakDemandInput = document.getElementById("{{ form.off_peak_demand_kwh.id_for_label }}");

    // Call this function both on change and on initial load
    function updateFieldAccessibility() {
        if (utilityTypeSelect.value === 'natural_gas') {
            totalGasChargesInput.disabled = false;
            gasConsumptionInput.disabled = false;
            totalElectricChargesInput.disabled = true;
            electricConsumptionInput.disabled = true;
            electricPeakDemandInput.disabled = true;
            electricOffPeakDemandInput.disabled = true;
        } else if (utilityTypeSelect.value === 'electric') {
            totalGasChargesInput.disabled = true;
            gasConsumptionInput.disabled = true;
            totalElectricChargesInput.disabled = false;
            electricConsumptionInput.disabled = false;
            electricPeakDemandInput.disabled = false;
            electricOffPeakDemandInput.disabled = false;
        }
    }

    // Attach the event listener and call the function on initial load
    utilityTypeSelect.addEventListener('change', updateFieldAccessibility);
    updateFieldAccessibility(); // Call on initial load
});
</script>
{% endblock %}




<!-- document.addEventListener('DOMContentLoaded', function() {
    const districtSelect = document.getElementById('bill_district');
    const schoolSelect = document.getElementById("{{ form.school.id_for_label }}");

    districtSelect.addEventListener('change', function() {
        const districtId = this.value;
        schoolSelect.innerHTML = '<option value="">Select School</option>'; 

        if (districtId) {
            schoolSelect.disabled = false;

            // Fetch schools for the selected district
            console.log(`Fetching schools for district ID: ${districtId}`);
            fetch(`/enerprize-api/get-schools-for-district/${districtId}/`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                data.schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.school_name;
                schoolSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error:', error));
        } else {
            // Disable school dropdown if no district is selected
            schoolSelect.disabled = true;
        }
    });
}); -->